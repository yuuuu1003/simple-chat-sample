<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ã‚ã–ã‚‰ã—ã®é­šã¨ã‚Šã‚²ãƒ¼ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  </head>
  <body style="text-align:center;">
    <h1>ğŸ‹ ã‚ã–ã‚‰ã—ã®é­šã¨ã‚Šã‚²ãƒ¼ãƒ  ğŸŸ</h1>
    <p>ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ã‚ã–ã‚‰ã—ã‚’å‹•ã‹ã—ã€é­šã‚’ã§ãã‚‹ã ã‘å¤šãå–ã‚ã†ï¼</p>
    <p>ã‚ãªãŸã®ID: <span id="myid"></span></p>
    <button id="connect">ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
    <br /><br />
    <button id="startBtn" style="font-size:20px; padding:10px 30px;">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <h3 id="score">Score: 0</h3>
    <h3 id="timer" style="transition: color 0.3s;">Time: 30.00 s</h3>

    <script>
      let socket = io.connect();
      let g = 0, b = 0;
      let myid = sessionStorage.getItem("clientId");

      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem("clientId", myid);
      }
      document.querySelector("#myid").innerHTML = myid;

      document.querySelector("#connect").addEventListener("click", () => {
        socket.emit("join", "game");
        document.querySelector("#connect").remove();
      });

      socket.on("sensor", data => {
        g = parseFloat(data.g);
        b = parseFloat(data.b);
      });

      // --- ã‚²ãƒ¼ãƒ å¤‰æ•° ---
      let x, y, vx = 0, vy = 0;
      let fishes = [];
      let score = 0;
      let startTime;
      const limit = 30 * 1000; // 30ç§’
      let gameStarted = false;
      let gameOver = false;

      function setup() {
        createCanvas(600, 600);
        resetGame();
      }

      function resetGame() {
        x = width / 2;
        y = height / 2;
        vx = 0; vy = 0;
        score = 0;
        fishes = [];
        for (let i = 0; i < 10; i++) {
          fishes.push({ 
            x: random(60, width - 60), 
            y: random(60, height - 60), 
            size: 25,
            respawnTimer: 0 // å†å‡ºç¾ç”¨ã‚¿ã‚¤ãƒãƒ¼
          });
        }
        gameStarted = false;
        gameOver = false;
        document.getElementById("score").textContent = "Score: 0";
        document.getElementById("timer").textContent = "Time: 30.00 s";
        document.getElementById("timer").style.color = "black";
      }

      function startGame() {
        if (!gameStarted) {
          startTime = millis();
          gameStarted = true;
          gameOver = false;
          document.getElementById("startBtn").disabled = true;
        }
      }

      document.getElementById("startBtn").addEventListener("click", startGame);

      function draw() {
        background(180, 220, 255);
        drawIce();

        if (gameStarted && !gameOver) {
          let elapsed = millis() - startTime;
          let remaining = max(0, (limit - elapsed) / 1000);

          // 5ç§’ä»¥ä¸‹ã§ã‚¿ã‚¤ãƒãƒ¼ã®æ–‡å­—ã‚’èµ¤ã
          let timerEl = document.getElementById("timer");
          if (remaining <= 5) {
            timerEl.style.color = "red";
          } else {
            timerEl.style.color = "black";
          }

          timerEl.textContent = "Time: " + remaining.toFixed(2) + " s";
          if (remaining <= 0) gameOver = true;

          // ç§»å‹•
          vx += g * 0.05;
          vy += b * 0.05;
          vx *= 0.98;
          vy *= 0.98;
          x += vx; y += vy;
          x = constrain(x, 60, width - 60);
          y = constrain(y, 60, height - 60);

          // é­šã¨ã®å½“ãŸã‚Šåˆ¤å®šï¼‹è‡ªç„¶ãªãƒªã‚¹ãƒãƒ¼ãƒ³å‡¦ç†
          for (let f of fishes) {
            if (f.respawnTimer > 0) {
              f.respawnTimer -= deltaTime;
              continue;
            }

            if (dist(x, y, f.x, f.y) < 60) {
              score++;
              document.getElementById("score").textContent = "Score: " + score;
              f.respawnTimer = random(800, 1500); // 0.8ã€œ1.5ç§’å¾Œã«å†å‡ºç¾
              f.x = -9999; // ä¸€æ™‚çš„ã«éè¡¨ç¤ºã«ã—ã¦ãŠã
              f.y = -9999;
            }
          }

          // ã‚¿ã‚¤ãƒãƒ¼åˆ‡ã‚Œã§ãƒªã‚¹ãƒãƒ¼ãƒ³å‡¦ç†ã‚’å®Œäº†
          for (let f of fishes) {
            if (f.respawnTimer <= 0 && (f.x < 0 || f.y < 0)) {
              f.x = random(60, width - 60);
              f.y = random(60, height - 60);
            }
          }
        }

        // é­šã‚’æç”»
        for (let f of fishes) {
          if (f.respawnTimer <= 0) drawFish(f.x, f.y, f.size);
        }

        // ã‚ã–ã‚‰ã—æç”»
        azarashi(x, y);

        if (gameOver) {
          fill(0);
          textAlign(CENTER);
          textSize(32);
          text("ğŸŸ çµ‚äº†ï¼Score: " + score + " ğŸŸ", width / 2, 80);
          textSize(20);
          text("ã‚¿ãƒƒãƒ—ã§ãƒªãƒˆãƒ©ã‚¤", width / 2, 110);
          document.getElementById("startBtn").disabled = false;
        }
      }

      function mousePressed() {
        if (gameOver) resetGame();
      }

      // --- æ°·ã®åºŠã£ã½ã„æ¼”å‡º ---
      function drawIce() {
        noStroke();
        fill(240, 250, 255);
        ellipse(width / 2, height / 2, 500, 500);
        fill(220, 240, 255, 80);
        ellipse(width / 2, height / 2, 450, 450);
      }

      // --- é­š ---
      function drawFish(x, y, s) {
        fill(50, 100, 200);
        ellipse(x, y, s * 2, s);
        triangle(x - s, y, x - s - 10, y - 10, x - s - 10, y + 10);
        fill(255);
        ellipse(x + s / 2, y - s / 6, s / 3, s / 3);
        fill(0);
        circle(x + s / 2, y - s / 6, s / 6);
      }

      // --- ã‚ã–ã‚‰ã— ---
      function azarashi(x, y) {
        fill(255);
        stroke(0);
        strokeWeight(1);
        ellipse(x, y, 120, 100);
        circle(x - 50, y + 35, 35);
        circle(x + 50, y + 35, 35);
        fill(0);
        circle(x - 35, y - 5, 20);
        circle(x + 35, y - 5, 20);
        fill(255);
        circle(x - 40, y - 8, 7);
        circle(x + 31, y - 8, 7);
        fill(50, 150, 250, 130);
        ellipse(x, y + 10, 30, 20);
        fill(0);
        circle(x, y + 5, 5);
        fill(250, 30, 150, 68);
        ellipse(x - 43, y + 11, 22, 8);
        ellipse(x + 43, y + 11, 22, 8);
        noFill();
        strokeWeight(2);
        bezier(x - 10, y + 10, x - 8, y + 15, x, y + 15, x, y + 3);
        bezier(x, y + 3, x, y + 15, x + 8, y + 15, x + 10, y + 10);
      }
    </script>
  </body>
</html>