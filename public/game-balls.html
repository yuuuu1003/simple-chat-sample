<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>あざらしの魚とりゲーム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  </head>
  <body style="text-align:center;">
    <h1>🐋 あざらしの魚とりゲーム 🐟</h1>
    <p>スマホを傾けてあざらしを動かし、魚をできるだけ多く取ろう！</p>
    <p>あなたのID: <span id="myid"></span></p>
    <button id="connect">ルームに入る</button>
    <h3 id="score">Score: 0</h3>
    <h3 id="timer">Time: 30.00 s</h3>

    <script>
      // --- 通信設定 ---
      let socket = io.connect();
      let btn = document.querySelector("#connect");
      let g = 0, b = 0;

      let myid = sessionStorage.getItem("clientId");
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem("clientId", myid);
      }
      document.querySelector("#myid").innerHTML = myid;

      btn.addEventListener("click", () => {
        socket.emit("join", "game");
        btn.remove();
      });

      socket.on("sensor", data => {
        g = parseFloat(data.g);
        b = parseFloat(data.b);
      });

      // --- ゲーム変数 ---
      let x, y;
      let vx = 0, vy = 0;
      let fishes = [];
      let score = 0;
      let gameOver = false;
      let startTime;
      const limit = 30 * 1000; // 制限時間30秒

      function setup() {
        createCanvas(600, 600);
        resetGame();
      }

      function resetGame() {
        x = width / 2;
        y = height / 2;
        vx = 0;
        vy = 0;
        score = 0;
        fishes = [];
        for (let i = 0; i < 10; i++) {
          fishes.push({
            x: random(60, width - 60),
            y: random(60, height - 60),
            size: 25,
            caught: false,
          });
        }
        startTime = millis();
        gameOver = false;
      }

      function draw() {
        background(180, 220, 255); // 氷の海背景
        drawIce();

        // --- 経過時間 ---
        let elapsed = millis() - startTime;
        let remaining = max(0, (limit - elapsed) / 1000);
        document.getElementById("timer").textContent = "Time: " + remaining.toFixed(2) + " s";

        if (remaining <= 0) {
          gameOver = true;
        }

        if (!gameOver) {
          // --- 移動処理 ---
          vx += g * 0.05;
          vy += b * 0.05;
          vx *= 0.98;
          vy *= 0.98;
          x += vx;
          y += vy;
          x = constrain(x, 60, width - 60);
          y = constrain(y, 60, height - 60);

          // --- 魚と当たり判定 ---
          for (let f of fishes) {
            if (!f.caught && dist(x, y, f.x, f.y) < 60) {
              f.caught = true;
              score++;
              document.getElementById("score").textContent = "Score: " + score;
            }
          }
        }

        // --- 魚を描画 ---
        for (let f of fishes) {
          if (!f.caught) drawFish(f.x, f.y, f.size);
        }

        // --- あざらし描画 ---
        azarashi(x, y);

        // --- ゲーム終了時 ---
        if (gameOver) {
          fill(0);
          textAlign(CENTER);
          textSize(32);
          text("🐟 終了！Score: " + score + " 🐟", width / 2, 80);
          textSize(20);
          text("タップでリトライ", width / 2, 110);
        }
      }

      function mousePressed() {
        if (gameOver) resetGame();
      }

      // --- 氷床の演出 ---
      function drawIce() {
        noStroke();
        fill(240, 250, 255);
        ellipse(width / 2, height / 2, 500, 500);
        fill(220, 240, 255, 80);
        ellipse(width / 2, height / 2, 450, 450);
      }

      // --- 魚描画 ---
      function drawFish(x, y, s) {
        fill(50, 100, 200);
        ellipse(x, y, s * 2, s);
        triangle(x - s, y, x - s - 10, y - 10, x - s - 10, y + 10);
        fill(255);
        ellipse(x + s / 2, y - s / 6, s / 3, s / 3);
        fill(0);
        circle(x + s / 2, y - s / 6, s / 6);
      }

      // --- あざらし描画関数（あなたの作品） ---
      function azarashi(x, y) {
        fill(255);
        stroke(0);
        strokeWeight(1);
        ellipse(x, y, 120, 100);
        circle(x - 50, y + 35, 35);
        circle(x + 50, y + 35, 35);
        fill(0);
        circle(x - 35, y - 5, 20);
        circle(x + 35, y - 5, 20);
        fill(255);
        circle(x - 40, y - 8, 7);
        circle(x + 31, y - 8, 7);
        fill(50, 150, 250, 130);
        ellipse(x, y + 10, 30, 20);
        fill(0);
        circle(x, y + 5, 5);
        fill(250, 30, 150, 68);
        ellipse(x - 43, y + 11, 22, 8);
        ellipse(x + 43, y + 11, 22, 8);
        noFill();
        strokeWeight(2);
        bezier(x - 10, y + 10, x - 8, y + 15, x, y + 15, x, y + 3);
        bezier(x, y + 3, x, y + 15, x + 8, y + 15, x + 10, y + 10);
      }
    </script>
  </body>
</html>
